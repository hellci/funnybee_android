variables:
  ANDROID_COMPILE_SDK: "28"
  ANDROID_BUILD_TOOLS: "28.0.2"
  ANDROID_SDK_TOOLS:   "4333796"

before_script:
  - export JAVA_HOME="/usr/lib/jvm/java-1.8.0-openjdk-amd64"

stages:
- environment
- build
- test
- quality_assurance
- deploy

.update_container_job:
  image: docker:stable
  stage: environment
  services:
  - docker:dind
  script:
  - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
  - docker pull $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG || true
  - docker build --cache-from $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG -t $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG .
  - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG

update_container:
  extends: .update_container_job
  only:
    changes:
    - Dockerfile

ensure_container:
  extends: .update_container_job
  allow_failure: true
  before_script:
  - "mkdir -p ~/.docker && echo '{\"experimental\": \"enabled\"}' > ~/.docker/config.json"
  - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY
  # Skip update container `script` if the container already exists
  # via https://gitlab.com/gitlab-org/gitlab-ce/issues/26866#note_97609397 -> https://stackoverflow.com/a/52077071/796832
  - docker manifest inspect $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG > /dev/null && exit || true


lint_debug:
  stage: build
  script:
  - ./gradlew -Pci --console=plain :app:lintDebug -PbuildDir=lint

assemble_debug:
  stage: build
  script:
  - ./gradlew assembleDebug
  artifacts:
    paths:
    - app/build/outputs/

#debug_tests:
#  stage: test
#  script:
#  - ./gradlew -Pci --console=plain :app:testDebug
unit_tests:
  stage: test
  script:
  - ./gradlew test
  artifacts:
    name: "reports_${CI_PROJECT_NAME}_${CI_BUILD_REF_NAME}"
    when: on_failure
    expire_in: 4 days
    paths:
    - app/build/reports/tests/

instrumentation_tests:
  stage: test
  script:
  - emulator -avd testAVD -no-audio -no-window &
  - ./ci/android-wait-for-emulator.sh
  - adb devices
  - adb shell settings put global window_animation_scale 0 &
  - adb shell settings put global transition_animation_scale 0 &
  - adb shell settings put global animator_duration_scale 0 &
  - adb shell input keyevent 82 &
  - ./gradlew connectedAndroidTest
  - ./ci/stop-emulators.sh
  artifacts:
    name: "reports_${CI_PROJECT_NAME}_${CI_BUILD_REF_NAME}"
    when: on_failure
    expire_in: 4 days
    paths:
    - app/build/reports/androidTests/connected/

static_analysis:
  stage: quality_assurance
  script:
  - ./gradlew lint
  - ./gradlew checkstyle
  - ./gradlew pmd
  - ./gradlew findbugs
  artifacts:
    name: "reports_${CI_PROJECT_NAME}_${CI_BUILD_REF_NAME}"
    when: on_failure
    expire_in: 4 days
    paths:
    - app/build/reports/

deploy_internal:
  stage: deploy
  script:
  - bundle exec fastlane android deploy_debug_local
  when: manual